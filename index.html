<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>1 to 50 - 완전판</title>
        <link rel="stylesheet" href="1to50.css" />
    </head>
    <body>
        <div class="container">
            <h1>🎯 1 to 50</h1>

            <div class="game-info">
                <div class="info-item">
                    <div class="info-label">시간</div>
                    <div class="info-value" id="timer">0초</div>
                </div>
                <div class="info-item">
                    <div class="info-label">다음 숫자</div>
                    <div class="info-value" id="current-number">1</div>
                </div>
                <div class="info-item">
                    <div class="info-label">진행률</div>
                    <div class="info-value" id="progress">0%</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <button id="start-btn">🚀 게임 시작</button>

            <div id="game-board"></div>

            <div id="result"></div>

            <div class="buttons">
                <button class="btn btn-restart" onclick="restartGame()">🔄 다시하기</button>
                <button class="btn btn-ranking" onclick="showRanking()">🏆 랭킹 보기</button>
            </div>
        </div>

        <div class="ranking-modal" id="ranking-modal">
            <div class="ranking-content">
                <h2>🏆 랭킹</h2>
                <div id="ranking-list"></div>
                <button class="close-btn" onclick="closeRanking()">닫기</button>
            </div>
        </div>

        <script>
            let startTime, timerInterval;
            let currentNumber = 1;
            let gameData = [];
            let isGameActive = false;

            const timerDisplay = document.getElementById("timer");
            const currentNumberDisplay = document.getElementById("current-number");
            const progressDisplay = document.getElementById("progress");
            const progressFill = document.getElementById("progress-fill");
            const gameBoard = document.getElementById("game-board");
            const resultDisplay = document.getElementById("result");
            const startBtn = document.getElementById("start-btn");

            // 로컬 스토리지 대신 메모리에 랭킹 저장
            let rankings = [];

            function shuffle(array) {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }

            function updateProgress() {
                const progress = Math.round(((currentNumber - 1) / 50) * 100);
                progressDisplay.textContent = `${progress}%`;
                progressFill.style.width = `${progress}%`;
            }

            function startGame() {
                startBtn.style.display = "none";
                gameBoard.style.display = "grid";
                resultDisplay.textContent = "";
                resultDisplay.classList.remove("show");
                currentNumber = 1;
                isGameActive = true;
                gameData = [];

                updateProgress();
                currentNumberDisplay.textContent = currentNumber;

                const firstLayer = shuffle([...Array(25).keys()].map((n) => n + 1));
                const secondLayer = shuffle([...Array(25).keys()].map((n) => n + 26));

                gameBoard.innerHTML = "";

                for (let i = 0; i < 25; i++) {
                    const block = document.createElement("div");
                    block.className = "block";
                    block.dataset.index = i;

                    const front = document.createElement("div");
                    front.className = "layer front";
                    front.textContent = firstLayer[i];

                    const back = document.createElement("div");
                    back.className = "layer back";
                    back.textContent = secondLayer[i];

                    block.appendChild(front);
                    block.appendChild(back);

                    gameData.push({
                        element: block,
                        front: front,
                        back: back,
                        frontNum: firstLayer[i],
                        backNum: secondLayer[i],
                        isFlipped: false,
                    });

                    block.onclick = () => handleClick(i);
                    gameBoard.appendChild(block);
                }

                // 다음 숫자 강조
                highlightNextNumber();

                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 100);
            }

            function updateTimer() {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                timerDisplay.textContent = `${elapsed}초`;
            }

            function highlightNextNumber() {
                gameData.forEach((data) => {
                    data.element.classList.remove("pulse");
                    if (data.frontNum === currentNumber && !data.isFlipped) {
                        data.element.classList.add("pulse");
                    } else if (data.backNum === currentNumber && data.isFlipped) {
                        data.element.classList.add("pulse");
                    }
                });
            }

            function handleClick(index) {
                if (!isGameActive) return;

                const data = gameData[index];
                const { element, front, back, frontNum, backNum, isFlipped } = data;

                if (element.classList.contains("completed")) return;

                let isCorrect = false;

                if (!isFlipped && frontNum === currentNumber) {
                    // 앞면 클릭 정답
                    element.classList.add("flip");
                    data.isFlipped = true;
                    isCorrect = true;
                } else if (isFlipped && backNum === currentNumber) {
                    // 뒷면 클릭 정답
                    element.classList.add("completed");
                    isCorrect = true;
                } else {
                    // 틀린 답
                    element.classList.add("shake");
                    setTimeout(() => element.classList.remove("shake"), 500);
                    return;
                }

                if (isCorrect) {
                    currentNumber++;
                    currentNumberDisplay.textContent = currentNumber > 50 ? "완료!" : currentNumber;
                    updateProgress();
                    highlightNextNumber();

                    if (currentNumber > 50) {
                        endGame();
                    }
                }
            }

            function endGame() {
                isGameActive = false;
                clearInterval(timerInterval);
                const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);

                // 랭킹에 추가
                rankings.push({
                    time: parseFloat(totalTime),
                    date: new Date().toLocaleString(),
                });
                rankings.sort((a, b) => a.time - b.time);
                if (rankings.length > 10) rankings = rankings.slice(0, 10);

                resultDisplay.innerHTML = `
                🎉 <strong>완료!</strong><br>
                ⏱️ 총 소요 시간: <span style="color: #FFD700;">${totalTime}초</span><br>
                🏆 랭킹: ${rankings.findIndex((r) => r.time === parseFloat(totalTime)) + 1}위
            `;
                resultDisplay.classList.add("show");

                // 모든 블록 제거
                gameData.forEach((data) => {
                    data.element.classList.remove("pulse");
                });

                startBtn.style.display = "inline-block";
                startBtn.textContent = "🔄 다시 시작";
            }

            function restartGame() {
                clearInterval(timerInterval);
                startBtn.style.display = "inline-block";
                startBtn.textContent = "🚀 게임 시작";
                gameBoard.style.display = "none";
                resultDisplay.classList.remove("show");
                currentNumber = 1;
                isGameActive = false;
                timerDisplay.textContent = "0초";
                currentNumberDisplay.textContent = "1";
                progressDisplay.textContent = "0%";
                progressFill.style.width = "0%";
            }

            function showRanking() {
                const modal = document.getElementById("ranking-modal");
                const rankingList = document.getElementById("ranking-list");

                if (rankings.length === 0) {
                    rankingList.innerHTML = "<p>아직 기록이 없습니다.</p>";
                } else {
                    rankingList.innerHTML = rankings
                        .map(
                            (rank, index) => `
                    <div class="ranking-item">
                        <span>${index + 1}위</span>
                        <span>${rank.time}초</span>
                        <span>${rank.date.split(" ")[0]}</span>
                    </div>
                `
                        )
                        .join("");
                }

                modal.style.display = "flex";
            }

            function closeRanking() {
                document.getElementById("ranking-modal").style.display = "none";
            }

            // 이벤트 리스너
            startBtn.onclick = startGame;

            // 모달 외부 클릭 시 닫기
            document.getElementById("ranking-modal").onclick = (e) => {
                if (e.target.id === "ranking-modal") {
                    closeRanking();
                }
            };

            // 키보드 단축키
            document.addEventListener("keydown", (e) => {
                if (e.code === "Space" && !isGameActive) {
                    e.preventDefault();
                    startGame();
                } else if (e.code === "KeyR" && !isGameActive) {
                    e.preventDefault();
                    restartGame();
                }
            });
        </script>
    </body>
</html>
